<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.koron.inwlms.mapper.master.UserMapper">
   <insert id="addUser" parameterType="com.koron.inwlms.bean.DTO.sysManager.UserDTO">  
        insert into "SM_user"("loginName",passWord,phone,"Email",name,position,sex,photo,"openID",status,"workNo","whetUse","createBy","createTime","updateBy","updateTime")
        values(#{loginName},#{password},#{phone},#{Email},#{name},#{position},#{sex},#{photo},#{openID},0,#{workNo},0,#{createBy},#{createTime},#{updateBy},#{updateTime})     
    </insert>
    
    <select id="queryUser"  parameterType="com.koron.inwlms.bean.DTO.sysManager.QueryUserDTO"  resultType="com.koron.inwlms.bean.VO.sysManager.UserVO">
      select "user".id as "userId","user"."loginName","user".phone,"user"."Email","user".name,"user".position,"user".sex,"user".photo,"user"."openID","user".status,"user"."workNo",
	  "user"."whetUse","user"."createBy","user"."createTime","user"."updateBy","user"."updateTime","dept".name as "depname"      
	   from "SM_user" as "user"       
	   left join "SM_userDept" as "userdept" on "userdept"."userID"="user".id    
	   left join "SM_department" as "dept"   on "dept".id="userdept"."deptID"       
       <trim prefix="where" prefixOverrides="and|or">
		<if test="name != null  and name !='' "> and "user".name like '%${name}%'</if>  
   	    <if test="depName != null  and depName !='' "> and "dept" like '%${depName}%'</if>
   	    <if test="userId != null"> and "user".id ='${userId}'</if>  
   	    <if test="status != null"> and "user".status ='${status}'</if>
   	    <if test="whetUse != null"> and "user"."whetUse" ='${whetUse}'</if>          
	  </trim>
    </select>
    
    <update id="editUser" parameterType="com.koron.inwlms.bean.DTO.sysManager.UserDTO">   
		update "SM_user" 
		<set>	    
             <if test="name != null  and name !=''" > name = #{name},  </if>                       
             <if test="loginName != null and loginName !=''" > "loginName" = #{loginName},</if>            
             <if test="password != null and password !=''" > password = #{password}, </if>                       
             <if test="sex != null" >sex = #{sex,jdbcType=INTEGER}, </if>                        
             <if test="Email != null and Email != ''" > "Email" = #{Email}, </if>               
             <if test="updateBy != null and updateBy!=''" >  "updateBy" = #{updateBy},</if>                        
             <if test="updateTime != null" > "updateTime" = #{updateTime},</if>  
             <if test="status != null" > status = #{status},  </if>               
		</set>
		where id=#{userId}
     </update>
     
    <update id="delUser" parameterType="com.koron.inwlms.bean.DTO.sysManager.UserDTO">   
		update "SM_user" 
		<set>	                                 
             <if test="whetUse != null" > "whetUse" = #{whetUse},</if> 
        </set>
		where id=#{userId}
     </update>
     
      <insert id="addNewRole" parameterType="com.koron.inwlms.bean.DTO.sysManager.RoleDTO">  
        insert into "SM_userRole"(name,remark,"createBy","createTime","updateBy","updateTime")
        values(#{roleName},#{roleRemark},#{createBy},#{createTime},#{updateBy},#{updateTime})     
    </insert>
    
    <update id="editRoleAttr" parameterType="com.koron.inwlms.bean.DTO.sysManager.RoleDTO">   
		update "SM_userRole" 
		<set>	                                 
             <if test="roleName != null" > name= #{roleName},</if>            
             <if test="roleRemark != null" > remark= #{roleName},</if>
             <if test="updateBy != null and updateBy!=''" > "updateBy" = #{updateBy},</if>                        
             <if test="updateTime != null" > "updateTime" = #{updateTime},</if>   
        </set>
		where id=#{roleId}
     </update>
     
     <select id="queryRoleUser"  parameterType="com.koron.inwlms.bean.DTO.sysManager.RoleDTO"  resultType="com.koron.inwlms.bean.VO.sysManager.RoleMsgVO">
       select "userRole".name as roleName
       from  "SM_userRoleRelation" as "userRela"
       left join  "SM_userRole" as "userRole" on "userRole".id="userRela"."roleID"
       where "userRela"."roleID"=#{roleId}
    </select>
    
    <!-- 批量删除角色信息 -->
    <delete id="delRole" parameterType="int">
        delete from "SM_userRole" where id in
        <foreach item="roleItem" collection="list" open="(" separator="," close=")">
            #{roleItem}
        </foreach>
    </delete>
    
    <!--根据角色ID加载角色人员列表接口 -->
     <select id="queryUserByRoleId"  parameterType="com.koron.inwlms.bean.DTO.sysManager.RoleDTO"  resultType="com.koron.inwlms.bean.VO.sysManager.UserVO">
       select "user".id as "userId","user"."loginName","user".passWord,"user".phone,"user"."Email","user".name,"user".position,"user".sex,"user".photo,"user"."openID","user".status,"user"."workNo",
	  "user"."whetUse","user"."createBy","user"."createTime","user"."updateBy","user"."updateTime","dept".name as "depname"
       from "SM_userRoleRelation" as "userRela"
       left join "SM_user" as "user" on "userRela"."userID"="user".id
       left join "SM_userDept" as "userdept" on "userdept"."userID"="user".id    
	   left join "SM_department" as "dept"   on "dept".id="userdept"."deptID"
       where "userRela"."roleID"=#{roleId}
    </select>
    
    <!--查询所有角色列表 -->
    <select id="queryAllRole"  resultType="com.koron.inwlms.bean.VO.sysManager.RoleVO">
       select id as "roleId",name as "roleName",remark as "roleRemark","createBy","createTime","updateBy","updateTime" 
       from "SM_userRole" 
    </select>
    
    <!--遍历插入职员与角色的关系 -->
    <insert id="addRoleUser" parameterType="java.util.List">  
        insert into "SM_userRoleRelation"("userID", "roleID","createBy","createTime","updateBy","updateTime")values
		<foreach collection="list" item="roleuser"  index="index" separator=",">
			(${roleuser.userId}, ${roleuser.roleId}, #{roleuser.createBy}, #{roleuser.createTime}, #{roleuser.updateBy}, #{roleuser.updateTime})
		</foreach>
    </insert>
    
     <!-- 批量删除角色中员工信息 -->
    <delete id="delRoleUser">
        delete from "SM_userRoleRelation" where "roleID"=#{roleId} 
        and "userID" in
        <foreach item="userItem" collection="list" open="(" separator="," close=")">
            #{userItem}
        </foreach>
    </delete>
    
     <!-- 角色弹窗选择职员 -->
     <select id="queryExceptRoleUser"  parameterType="com.koron.inwlms.bean.DTO.sysManager.RoleAndUserDTO"  resultType="com.koron.inwlms.bean.VO.sysManager.UserVO">
       select "user".id as "userId","user"."loginName","user".phone,"user"."Email","user".name,"user".position,"user".sex,"user".photo,"user"."openID","user".status,"user"."workNo",
	   "user"."whetUse","user"."createBy","user"."createTime","user"."updateBy","user"."updateTime","dept".name as "depname"      
	   from "SM_user" as "user"       
	   left join "SM_userDept" as "userdept" on "userdept"."userID"="user".id    
	   left join "SM_department" as "dept"   on "dept".id="userdept"."deptID" 
	   where "user".id not in(select "userrela"."userID" from "SM_userRoleRelation" as "userrela" where "userrela"."roleID" =#{roleId})	 
     </select>
     
      <!-- 部门弹窗选择职员 -->
     <select id="queryExceptDeptUser"  parameterType="com.koron.inwlms.bean.DTO.sysManager.DeptAndUserDTO"  resultType="com.koron.inwlms.bean.VO.sysManager.UserVO">
       select "user".id as "userId","user"."loginName","user".phone,"user"."Email","user".name,"user".position,"user".sex,"user".photo,"user"."openID","user".status,"user"."workNo",
	   "user"."whetUse","user"."createBy","user"."createTime","user"."updateBy","user"."updateTime","dept".name as "depname"      
	   from "SM_user" as "user"       
	   left join "SM_userDept" as "userdept" on "userdept"."userID"="user".id    
	   left join "SM_department" as "dept"   on "dept".id="userdept"."deptID" 
	   where "user".id not in(select "deptuser"."userID" from "SM_userDept" as "deptuser" where "deptuser"."deptID" =#{depId})	 
     </select>
     
     <!--遍历插入职员与部门的关系 -->
    <insert id="addDeptUser" parameterType="java.util.List">  
        insert into "SM_userDept"("userID", "deptID","createBy","createTime")values
		<foreach collection="list" item="deptuser"  index="index" separator=",">
			(${deptuser.userId}, ${deptuser.depId}, #{deptuser.createBy}, #{deptuser.createTime})
		</foreach>
    </insert>
    
     <!-- 批量删除部门中员工信息 -->
    <delete id="delDeptUser">
        delete from "SM_userDept" where "deptID"=#{depId} 
        and "userID" in
        <foreach item="userItem" collection="list" open="(" separator="," close=")">
            #{userItem}
        </foreach>
    </delete>
    
    <!-- 插入数据字典主表信息一条记录 -->
    <select id="addDataDic" parameterType="com.koron.inwlms.bean.DTO.sysManager.DataDicDTO" resultType="Integer">  
        insert into "SM_dataDictionary"(name,remark,flag,"createBy","createTime","updateBy","updateTime")
        values(#{dicName},#{dicRemark},#{dicFlag},#{createBy},#{createTime},#{updateBy},#{updateTime})returning id         
    </select>
     <!-- 遍历插入数据字典明细信息多条记录 -->
     <insert id="addDataDetDic" parameterType="java.util.List">  
        insert into "SM_dataDictionaryDet"("dictID",name,value,"createBy","createTime","updateBy","updateTime")values
		<foreach collection="list" item="detdata"  index="index" separator=",">
			(${detdata.dictId}, #{detdata.dicDetName},#{detdata.dicDetValue}, #{detdata.createBy}, #{detdata.createTime}, #{detdata.updateBy}, #{detdata.updateTime})
		</foreach>
    </insert>
    
     <!-- 查询数据字典接口说明(通过名称标识等等)  -->
     <select id="queryDataDic"  parameterType="com.koron.inwlms.bean.DTO.sysManager.DataDicDTO"  resultType="com.koron.inwlms.bean.VO.sysManager.DataDicVO">
       select "dic".id as "dicId","dic".name as "dicName","dic".remark as "dicRemark","dic".flag as "dicFlag", 
	   string_agg(concat("dicDet".name,'-',"dicDet"."value"),',') as "dicDetNameAndValue"
       from "SM_dataDictionary" as "dic"
       left join  "SM_dataDictionaryDet" as "dicDet" on "dicDet"."dictID"="dic".id  
       <trim prefix="where" prefixOverrides="and|or">
		<if test="dicName != null  and dicName !='' "> and "dic".name like '%${dicName}%'</if>  
   	    <if test="dicFlag != null  and dicFlag !='' "> and "dic".flag like '%${dicFlag}%'</if>
   	     group by "dic".id,"dic".name,"dic".remark,"dic".flag
	  </trim>
    </select>
    
     <!-- 查询数据字典接口说明(通过字典主表Id)  -->
     <select id="queryDicById"  parameterType="com.koron.inwlms.bean.DTO.sysManager.DataDicDTO"  resultType="com.koron.inwlms.bean.VO.sysManager.DataDicVO">
       select "dic".id as "dicId","dic".name as "dicName","dic".remark as "dicRemark","dic".flag as "dicFlag", 
	   "dicDet".id as "dicDetId","dicDet"."dictID" as "dictId","dicDet".name as "dicDetName","dicDet"."value"as "dicDetValue"
       from "SM_dataDictionary" as "dic"
       left join  "SM_dataDictionaryDet" as "dicDet" on "dicDet"."dictID"="dic".id  
       where "dic".id=#{dicId}
    </select>
    
    
</mapper>