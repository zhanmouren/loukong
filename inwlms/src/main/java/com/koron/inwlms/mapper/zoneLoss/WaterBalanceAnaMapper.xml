<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.koron.inwlms.mapper.zoneLoss.WaterBalanceAnaMapper">

	<select id="queryZoneWBMLossData" resultType="com.koron.inwlms.bean.VO.zoneLoss.ZoneWBLossVO">
		select 
		<if test="(qzlDTO.zoneNo == null or qzlDTO.zoneNo == '') and (qzlDTO.zoneRank == null or qzlDTO.zoneRank == '')">
			sum(case when b.code='WNMFWSSITDF' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "totalMeterFlow",
			sum(case when b.code='WNMBC' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "meterReadFlow",
			sum(case when b.code='WNMWL' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "lossFlow",
			<!-- 漏损率暂定 -->
			0.1 as "lossRate",
			b."zoneNo"
		</if>
		<if test="qzlDTO.zoneRank == 1">
			<!-- 一级分区 -->
			sum(case when b.code='FLMFWSSITDF' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "totalMeterFlow",
			sum(case when b.code='FLMBC' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "meterReadFlow",
			sum(case when b.code='FLMWL' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "lossFlow",
			<!-- 漏损率暂定 -->
			0.1 as "lossRate",
			b."zoneNo"
		</if>
		<if test="qzlDTO.zoneNo != null and qzlDTO.zoneNo != '' and qzlDTO.zoneRank == 3">
			<!-- DMA/PMA -->
			sum(case when b.code='DMMFWSSITDF' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "totalMeterFlow",
			sum(case when b.code='DMMBC' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "meterReadFlow",
			sum(case when b.code='DMMWL' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "lossFlow",
			<!-- 漏损率暂定 -->
			0.1 as "lossRate",
			b."zoneNo"
		</if>
		from
		(select a.id,m."yearMonth",a.code,a.value,ind.precision as precision,a."zoneNo"
		from (
			select id,"yearMonth",code,value,"zoneNo" from "ANA_zone_balance_month"
			where 1= 1
			<if test="lists != null and lists.size > 0">
				and "zoneNo" in 
				<foreach item="item" collection="lists" separator="," open="(" close=")" index="">    
					#{item.zoneNo}    
				</foreach> 
			</if>
			<if test="lists == null or lists.size == 0">
				and "zoneNo" is null 
			</if>
		) a, "LC_APP_dim_indicator" ind, "APP_dim_month" m where ind.code = a.code 
		and m.id = a."yearMonth" and m."yearMonth" &gt;= #{qzlDTO.startTime} 
		and m."yearMonth" &lt;= #{qzlDTO.endTime}) b
		group by b."zoneNo";
	</select>
	
	<select id="queryZoneWBYLossData" resultType="com.koron.inwlms.bean.VO.zoneLoss.ZoneWBLossVO">
		select 
		<if test="(qzlDTO.zoneNo == null or qzlDTO.zoneNo == '') and (qzlDTO.zoneRank == null or qzlDTO.zoneRank == '')">
			sum(case when b.code='WNMFWSSITDF' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "totalMeterFlow",
			sum(case when b.code='WNMBC' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "meterReadFlow",
			sum(case when b.code='WNMWL' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "lossFlow",
			<!-- 漏损率暂定 -->
			0.1 as "lossRate",
			b."zoneNo"
		</if>
		<if test="qzlDTO.zoneNo != null and qzlDTO.zoneNo != '' and qzlDTO.zoneRank == 1">
			<!-- 一级分区 -->
			sum(case when b.code='FLMFWSSITDF' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "totalMeterFlow",
			sum(case when b.code='FLMBC' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "meterReadFlow",
			sum(case when b.code='FLMWL' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "lossFlow",
			<!-- 漏损率暂定 -->
			0.1 as "lossRate",
			b."zoneNo"
		</if>
		<if test="qzlDTO.zoneNo != null and qzlDTO.zoneNo != '' and qzlDTO.zoneRank == 3">
			<!-- DMA/PMA -->
			sum(case when b.code='DMMFWSSITDF' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "totalMeterFlow",
			sum(case when b.code='DMMBC' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "meterReadFlow",
			sum(case when b.code='DMMWL' then round( value/b.precision :: NUMERIC, 2 ) else 0 end) as "lossFlow",
			<!-- 漏损率暂定 -->
			0.1 as "lossRate",
			b."zoneNo"
		</if>
		from
		(select a.id,a.year,a.code,a.value,ind.precision as precision,a."zoneNo"
		from (
			select id,year,code,value,"zoneNo" from "ANA_zone_balance_year"
			where year &gt;= #{startTime} and year &lt;= #{endTime}
			<if test="lists != null and lists.size > 0">
				and "zoneNo" in 
				<foreach item="item" collection="lists" separator="," open="(" close=")" index="">    
					#{item.zoneNo}    
				</foreach> 
			</if>
			<if test="lists == null or lists.size == 0">
				and "zoneNo" is null 
			</if>
		) a,"LC_APP_dim_indicator" ind where ind.code = a.code 
		) b
		group by b."zoneNo";
	</select>
	
	<select id="queryWNWBReportList" parameterType="com.koron.inwlms.bean.DTO.zoneLoss.QueryWNWBReportListDTO"
		resultType="com.koron.inwlms.bean.VO.zoneLoss.WNWBReportListVO">
		select 
		id,"reportName","dateType" as "timeType","reportTime",description,
		"createTime","createBy" as "userName","updateTime" 
		from "APP_company_report"
		where 1 = 1
		<if test="reportName != null and reportName != ''">
			and "reportName" like '%'||#{reportName}||'%'
		</if>
		<if test="timeType != null and timeType != ''">
			and "dateType" = #{timeType}
		</if>
		<if test="startTime !='' and startTime !=null">
			and "reportTime" &gt;= #{startTime}
		</if>
		<if test="endTime !='' and endTime !=null">
			and "reportTime" &lt;= #{endTime}
		</if>
		limit #{pageCount} OFFSET #{pageCount}*(#{page}-1);
	</select>
	
	<select id="countWNWBReportList" parameterType="com.koron.inwlms.bean.DTO.zoneLoss.QueryWNWBReportListDTO" 
	resultType="java.lang.Integer">
		select count(1) from "APP_company_report"
		where 1 = 1
		<if test="reportName != null and reportName != ''">
			and "reportName" like '%'||#{reportName}||'%'
		</if>
		<if test="timeType != null and timeType != ''">
			and "dateType" = #{timeType}
		</if>
		<if test="startTime !='' and startTime !=null">
			and "reportTime" &gt;= #{startTime}
		</if>
		<if test="endTime !='' and endTime !=null">
			and "reportTime" &lt;= #{endTime}
		</if>
	</select>
</mapper>